
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /** ========================= USERS ========================= **/
    match /users/{userId} {
      allow get, create, update, delete: if isOwner(userId) || isAdmin();
      allow list: if false;

      match /favorites/{favoriteId} {
        allow get, create, update, delete: if isOwner(userId) || isAdmin();
        allow list: if false;
      }
    }

    /** ========================= MATCHES ========================= **/
    match /matches/{matchId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /** ========================= COMPETITIONS ========================= **/
    match /competitions/{competitionId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /** ========================= TEAMS ========================= **/
    match /teams/{teamId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /** ========================= NEWS ========================= **/
    match /news/{newsId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /** ========================= ADMINS ========================= **/
    match /admins/{adminId} {
      // المدير نفسه فقط يمكنه قراءة بياناته، ولا يمكن لأي مستخدم آخر معرفة من هم المدراء
      allow get: if isAdmin() || isOwner(adminId);
      allow list: if false;
      allow create, update, delete: if false; // تتم إدارة الأدمن من Functions فقط
    }

    /** ========================= PREDICTIONS ========================= **/
    match /predictionFixtures/{fixtureId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();

      match /userPredictions/{userId} {
        allow get: if isOwner(userId) || isAdmin();
        allow list: if isAdmin();
        allow create: if isOwner(userId) && !exists(resource.path);
        allow update: if isOwner(userId) && (!('finished' in resource.data) || resource.data.finished == false);
        allow delete: if false;
      }
    }
    
    // Fallback for all other collections to be readable by anyone, but writable only by admin
    match /{path=**} {
        allow read: if true;
        allow write: if isAdmin();
    }
  }

  /* ========================= HELPER FUNCTIONS ========================= */
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isAdmin() {
    return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
  }
}
